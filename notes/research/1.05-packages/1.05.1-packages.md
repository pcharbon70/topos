# Package Management in Topos
## Core Design Philosophy: Where Data Flows, Never Mutates, Everything is Documented, and Packages are Shared

### 1. **Package Definition and Metadata**

```topos
-- Package.topos file (required at project root)
package {
  name: "topos_web",
  version: "1.2.3",
  
  description: "Functional web framework using category theory principles",
  
  authors: [
    { name: "Alice Dev", email: "alice@example.com", github: "alicedev" }
  ],
  
  license: "Apache-2.0",
  
  links: {
    github: "https://github.com/topos-lang/topos_web",
    documentation: "https://hexdocs.pm/topos_web",
    changelog: "https://github.com/topos-lang/topos_web/blob/main/CHANGELOG.md"
  },
  
  -- Dependencies from Hex.pm (Topos, Elixir, or Erlang packages)
  deps: {
    topos_core: "~> 2.1",
    jason: "~> 1.4",  -- Can use Elixir packages!
    cowboy: "~> 2.9",  -- And Erlang packages!
    topos_test: "~> 1.0" only: [test]
  },
  
  -- Package metadata for Hex.pm
  hex: {
    maintainers: ["Alice Dev", "Bob Smith"],
    licenses: ["Apache-2.0"],
    files: ["lib", "docs", "README.md", "LICENSE"],
    build_tools: ["topos"],
    
    -- Extra metadata for discoverability
    extra: {
      category: "Web",
      tags: ["web", "framework", "functional", "category-theory"]
    }
  },
  
  -- Documentation configuration
  docs: {
    main: "README",  -- Main documentation page
    logo: "assets/logo.png",
    
    -- HexDocs specific configuration
    hexdocs: {
      source_url: "https://github.com/topos-lang/topos_web",
      source_ref: version,
      extras: ["README.md", "CHANGELOG.md", "guides/getting-started.md"],
      groups_for_modules: {
        "Core": [ToposWeb.Router, ToposWeb.Controller],
        "Middleware": [ToposWeb.Auth, ToposWeb.CORS],
        "Testing": [ToposWeb.Test, ToposWeb.MockClient]
      },
      groups_for_functions: {
        "Request Handling": "&handle_/1",
        "Routing": "&route_/2",
        "Middleware": "&middleware_/1"
      }
    }
  },
  
  -- Minimum Topos version required
  requires: "topos ~> 1.0"
}
```

### 2. **Package Management CLI**

```bash
# Initialize new package
$ topos package init
Creating new Topos package...
Package name: my_lib
Version: 0.1.0
Description: My awesome library
License: MIT
✓ Created Package.topos
✓ Created lib/
✓ Created test/
✓ Created README.md

# Add dependencies
$ topos deps add topos_web ~> 1.2
✓ Added topos_web ~> 1.2 to Package.topos
✓ Running dependency resolution...
✓ Fetched topos_web 1.2.3
✓ Fetched topos_core 2.1.0 (transitive)

# Fetch all dependencies
$ topos deps get
Resolving dependencies...
✓ topos_web 1.2.3
✓ jason 1.4.1 (Elixir package)
✓ cowboy 2.9.0 (Erlang package)
All dependencies fetched successfully!

# Update dependencies
$ topos deps update topos_web
Updating topos_web...
✓ Updated topos_web from 1.2.3 to 1.2.5

# Tree view of dependencies
$ topos deps tree
my_lib 0.1.0
├── topos_web 1.2.5
│   ├── topos_core 2.1.0
│   └── cowboy 2.9.0
└── jason 1.4.1
```

### 3. **Publishing to Hex.pm**

```bash
# Validate package before publishing
$ topos package validate
Validating package my_lib v0.1.0...
✓ Package.topos is valid
✓ All required files present
✓ Documentation builds successfully
✓ All tests pass
✓ No compilation warnings
✓ License file exists
✓ Version follows semantic versioning

# Build documentation for review
$ topos docs build
Building documentation...
✓ Generated HexDocs-compatible documentation
✓ Preview at: http://localhost:4000

# Publish to Hex.pm
$ topos package publish
Publishing my_lib v0.1.0 to Hex.pm...

Documentation Preview:
  Main: README.md
  Modules: 15 documented
  Functions: 127 documented
  Examples: 45 runnable
  Coverage: 98%

Files included (1.2 MB):
  lib/**/*.tps
  docs/**/*
  README.md
  LICENSE
  Package.topos

Proceed with publishing? [y/N]: y
Enter Hex.pm password: ****
✓ Package published successfully!
✓ Documentation published to HexDocs
View at: https://hexdocs.pm/my_lib/0.1.0

# Retire a package version
$ topos package retire 0.1.0 --reason "Critical bug in API"
✓ Version 0.1.0 retired on Hex.pm
```

### 4. **HexDocs-Compatible Documentation Generation**

```topos
-- Documentation annotations that map to HexDocs format
doc """
  ToposWeb is a functional web framework built on category theory.
  
  ## Features
  
  * **Immutable Request/Response** - All HTTP data is immutable
  * **Composable Middleware** - Chain middleware using morphisms
  * **Type-Safe Routing** - Routes verified at compile-time
  
  ## Getting Started
  
      package deps: {
        topos_web: "~> 1.2"
      }
  
  Then define your router:
  
      module MyApp.Router = {
        use ToposWeb.Router
        
        route GET "/" HomeController.index
        route GET "/users/:id" UserController.show
      }
"""
doc moduledoc true  -- Marks as module documentation for HexDocs
doc since "1.0.0"
module ToposWeb = {
  
  doc """
    Creates a new router with the given configuration.
    
    ## Examples
    
        router = Router.new {
          middleware: [Logger, Auth],
          error_handler: ErrorHandler
        }
    
    ## Options
    
    * `:middleware` - List of middleware morphisms to apply
    * `:error_handler` - Module to handle errors
    * `:timeout` - Request timeout in milliseconds (default: 30_000)
  """
  doc section "Router"  -- Groups in HexDocs sidebar
  doc deprecated "2.0.0" message: "Use Router.create instead"
  flow new : Config -> Router
  
  -- Callback documentation (for behaviors/protocols)
  doc callback """
    Handles incoming HTTP request.
    
    This callback is invoked for each matching route.
    It should return a valid Response or an Error.
  """
  callback handle_request : Request -> Response
}
```

### 5. **Documentation Formatting for HexDocs**

```topos
-- Special documentation processors for HexDocs compatibility
module DocGen = {
  
  doc "Generate HexDocs-compatible JSON"
  flow to_hexdocs : Module -> HexDocsJSON
  flow to_hexdocs module =
    { 
      -- Standard HexDocs structure
      name: module.@@doc.name,
      version: module.@@doc.version,
      
      -- Module documentation
      modules: module.all_modules 
        |> List.map format_module_doc,
      
      -- Type documentation  
      types: module.all_types
        |> List.map format_type_doc,
        
      -- Function documentation with proper grouping
      functions: module.all_functions
        |> List.map format_function_doc
        |> group_by_category,
      
      -- Callbacks for behaviors
      callbacks: module.all_callbacks
        |> List.map format_callback_doc,
      
      -- Extra pages (guides, changelog, etc)
      extras: module.@@doc.extras
        |> List.map process_markdown,
      
      -- Search data for HexDocs search
      search_data: generate_search_index module
    }
  
  -- Convert Topos doc syntax to ExDoc/HexDocs format
  doc "Format documentation with HexDocs conventions"
  flow format_function_doc : Function -> HexDocEntry
  flow format_function_doc func =
    {
      name: func.name,
      arity: func.arity,
      
      -- Convert to HexDocs markdown format
      doc: func.@@doc.description
        |> add_specs_section func.type_signature
        |> add_examples_section func.@@doc.examples
        |> add_params_section func.@@doc.params
        |> convert_to_hexdocs_markdown,
      
      -- HexDocs metadata
      deprecated: func.@@doc.deprecated,
      since: func.@@doc.since,
      group: func.@@doc.section,
      
      -- Cross-references for linking
      see_also: func.@@doc.see_also
        |> List.map generate_hexdocs_link
    }
}
```

### 6. **Interoperability with Elixir/Erlang Packages**

```topos
-- Using Elixir packages in Topos
import Jason  -- Elixir JSON library

doc "Serialize data to JSON using Elixir's Jason library"
flow to_json : a -> Result Text Error
flow to_json data =
  -- Automatic conversion between Topos and Elixir types
  data
  |> to_elixir_term  -- Convert Topos types to Elixir
  |> Jason.encode
  |> from_elixir_result  -- Convert back to Topos Result

-- Using Erlang packages
import :cowboy  -- Erlang web server

doc "Start Cowboy web server with Topos handlers"
flow start_server : Natural -> IO Unit
flow start_server port =
  let routes = compile_routes our_routes in
  :cowboy.start_clear(
    :topos_http,
    [{:port, port}],
    %{env: %{dispatch: routes}}
  )

-- Exposing Topos modules for Elixir/Erlang use
doc "Export this module as an Erlang behavior"
export_erlang behaviour: true, app: :topos_app
module ToposServer = {
  -- Topos functions callable from Elixir/Erlang
  export flow handle_call : term -> pid -> state -> (reply, state)
  export flow handle_cast : term -> state -> state
}
```

### 7. **Package Testing and CI Integration**

```topos
-- Test configuration for packages
test {
  -- Test files pattern
  files: "test/**/*_test.tps",
  
  -- Coverage requirements for publishing
  coverage: {
    minimum: 80,
    ignore: ["test/", "docs/"]
  },
  
  -- Property testing configuration
  properties: {
    runs: 1000,
    seed: auto,
    shrinking: true
  },
  
  -- Doctest extraction from documentation
  doctest: {
    extract_from: ["lib/**/*.tps"],
    run_examples: true,
    verify_properties: true
  }
}

-- GitHub Actions workflow generated by Topos
doc "Generate CI configuration for the package"
flow generate_ci : Package -> Text
flow generate_ci package =
  """
  name: Topos CI
  on: [push, pull_request]
  
  jobs:
    test:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - uses: topos-lang/setup-topos@v1
          with:
            topos-version: '~> 1.0'
        - run: topos deps get
        - run: topos test
        - run: topos docs build
        - run: topos package validate
  """
```

### 8. **Package Versioning and Dependencies**

```topos
-- Semantic versioning support
module Version = {
  doc "Parse and compare semantic versions"
  shape Version = { major: Natural, minor: Natural, patch: Natural }
  
  doc "Check if version satisfies requirement"
  flow satisfies : Text -> Text -> Bool
  flow satisfies requirement version =
    parse_requirement requirement
    |> matches (parse_version version)
  
  doc "Resolve dependencies using Hex.pm resolver"
  flow resolve_deps : List Dependency -> Result LockFile Error
  flow resolve_deps deps =
    deps
    |> fetch_all_versions_from_hex
    |> solve_constraints
    |> generate_lock_file
}

-- Lock file for reproducible builds (topos.lock)
lock {
  topos_web: {
    version: "1.2.3",
    checksum: "sha256:abcd1234...",
    source: "hexpm",
    deps: [topos_core]
  },
  jason: {
    version: "1.4.1", 
    checksum: "sha256:efgh5678...",
    source: "hexpm",
    runtime: "elixir"
  }
}
```

### 9. **Package Organization and Namespacing**

```topos
-- Standard package structure
/*
my_package/
├── Package.topos          # Package metadata
├── topos.lock            # Locked dependencies
├── README.md               # Main documentation
├── LICENSE                 # License file
├── CHANGELOG.md           # Version history
├── lib/                   # Source code
│   ├── my_package.tps # Main module
│   └── my_package/        # Submodules
├── test/                  # Tests
│   └── my_package_test.tps
├── docs/                  # Additional documentation
│   ├── guides/           # User guides
│   └── api/             # API documentation
└── examples/            # Example code
*/

-- Namespace management
doc "Package namespace prevents conflicts"
package namespace MyPackage

-- All modules automatically prefixed
module Router = { ... }  -- Actually MyPackage.Router

-- Import with aliasing
import ToposWeb.Router as WebRouter
import Phoenix.Channel  -- Use Elixir modules directly
```

### 10. **Private Packages and Organizations**

```topos
-- Configure private Hex.pm repository
package {
  name: "company_internal_lib",
  version: "2.1.0",
  
  -- Private repository configuration
  hex: {
    organization: "mycompany",  -- Private org on Hex.pm
    repo: "private",
    
    -- Authentication for private packages
    auth: {
      method: "key",
      key_name: "TOPOS_HEX_KEY"  -- From environment
    }
  },
  
  -- Mix private and public dependencies
  deps: {
    public_lib: "~> 1.0",
    company_lib: "~> 2.0" org: "mycompany"
  }
}

-- Publishing to private repository
-- $ topos package publish --organization mycompany
```

### 11. **Package Metrics and Analytics**

```topos
doc "Package health metrics for Hex.pm badges"
module PackageHealth = {
  
  doc "Generate shields.io compatible badge data"
  flow badge_data : Package -> BadgeJSON
  flow badge_data package =
    {
      version: package.version,
      downloads: fetch_hex_downloads package.name,
      license: package.license,
      build: if all_tests_pass package then "passing" else "failing",
      coverage: calculate_coverage package,
      docs: if docs_build package then "passing" else "failing"
    }
  
  doc "Track package usage and statistics"
  flow analytics : Package -> IO Analytics
  flow analytics package =
    Hex.API.get_stats package.name
    |> IO.map parse_statistics
}
```

### 12. **Documentation Search Integration**

```topos
-- Generate search index for HexDocs
doc "Create searchable documentation index"
flow generate_search_index : Module -> SearchIndex
flow generate_search_index module =
  {
    -- Full-text search entries
    entries: 
      (module.all_functions |> List.map index_function) <>
      (module.all_types |> List.map index_type) <>
      (module.all_modules |> List.map index_module),
    
    -- Type signatures for search
    signatures: module.all_functions
      |> List.map \f -> (f.name, f.type_signature),
    
    -- Autocomplete data
    autocomplete: generate_autocomplete_entries module,
    
    -- Cross-reference index
    references: build_reference_graph module
  }

-- Integration with HexDocs search
doc "Format for HexDocs JavaScript search"
flow to_hexdocs_search : SearchIndex -> JavaScript
flow to_hexdocs_search index =
  """
  searchNodes = #{index.to_json};
  searchIndex = #{build_lunr_index index};
  """
```

### Key Package Management Features Summary:

1. **Hex.pm Integration**: Native support for publishing to Hex.pm
2. **HexDocs Compatibility**: Documentation automatically formatted for HexDocs
3. **Interoperability**: Use Elixir/Erlang packages seamlessly
4. **Package.topos**: Central package configuration file
5. **Dependency Resolution**: Automatic version resolution with lock files
6. **Private Packages**: Support for private Hex organizations
7. **CLI Tools**: Complete package management CLI
8. **CI/CD Ready**: Generate GitHub Actions and other CI configurations
9. **Documentation Groups**: Organize docs with HexDocs groups
10. **Search Integration**: Full-text search for HexDocs
11. **Semantic Versioning**: Built-in version management
12. **Package Validation**: Pre-publish validation and health checks

:This design ensures Topos packages integrate seamlessly with the existing BEAM ecosystem while maintaining the language's functional and categorical principles. The documentation system produces HexDocs-compatible output automatically, making every Topos package immediately accessible to the wider community.
